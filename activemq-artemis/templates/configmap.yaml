apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "artemis.fullname" . }}-configure-common
  labels:
{{ include "artemis.labels.standard" . | indent 4 }}
data:

  template-common.xml: |
    <configuration xmlns="urn:activemq" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="urn:activemq /schema/artemis-configuration.xsd">

      <core xmlns="urn:activemq:core" xsi:schemaLocation="urn:activemq:core ">

        <cluster-user>exampleUser</cluster-user>
        <cluster-password>secret</cluster-password>

        {{- $name := default .Chart.Name .Values.nameOverride -}}
        {{- $fullname := include "artemis.fullname" . -}}
        {{- $releaseName := printf "%s-%s" .Release.Name $name | trunc 63 | trimSuffix "-" -}}
        {{- $releaseNamespace := .Release.Namespace -}}

        <connectors>
          {{ range $i,$t := until (int .Values.replicas) }}
          {{ range tuple "master" "slave" }}
          <connector name="{{ $fullname }}-{{ . }}-{{ $i }}">tcp://{{ $fullname }}-{{ . }}-{{ $i }}.{{ $releaseName }}-{{ . }}.{{ $releaseNamespace }}.svc.cluster.local:61616</connector>
          {{ end }}
          {{end}}
        </connectors>

        <cluster-connections>
          <cluster-connection name="{{ $releaseName }}">
            <address>jms</address>
            <connector-ref>netty-connector</connector-ref>
            <retry-interval>500</retry-interval>
            <retry-interval-multiplier>1.1</retry-interval-multiplier>
            <max-retry-interval>5000</max-retry-interval>
            <initial-connect-attempts>-1</initial-connect-attempts>
            <reconnect-attempts>-1</reconnect-attempts>
            <forward-when-no-consumers>true</forward-when-no-consumers>

            <message-load-balancing>ON_DEMAND</message-load-balancing>
            <max-hops>1</max-hops>

            <static-connectors>
            {{ range $i,$t := until (int .Values.replicas) }}
              {{ range tuple "master" "slave" }}
                <connector-ref>{{ $fullname }}-{{ . }}-{{ $i }}</connector-ref>
              {{ end }}
            {{ end }}
            </static-connectors>

         </cluster-connection>
       </cluster-connections>

    <!--predefined queues-->
        <queues>
            <queue name="jms:queue:Garmin.QueueGarminData15min_Batch_0">
                <address>jms.queue.selectorQueue</address>
                <filter string="color='red'"/>
                <durable>true</durable>
            </queue>
            <queue name="jms:queue:Garmin.QueueGarminData15min_Batch_0">
                <address>jms.queue.selectorQueue</address>
                <filter string="color='red'"/>
                <durable>true</durable>
            </queue>
            <queue name="jms:queue:Garmin.QueueGarminData15min_Batch_1">
                <address>jms.queue.selectorQueue</address>
                <filter string="color='red'"/>
                <durable>true</durable>
            </queue>
            <queue name="jms:queue:Garmin.QueueGarminData15min_Batch_2">
                <address>jms.queue.selectorQueue</address>
                <filter string="color='red'"/>
                <durable>true</durable>
            </queue>
            <queue name="jms:queue:Garmin.QueueGarminData15min_Batch_3">
                <address>jms.queue.selectorQueue</address>
                <filter string="color='red'"/>
                <durable>true</durable>
            </queue>
            <queue name="jms:queue:Garmin.QueueGarminData24h_Batch_Monday">
                <address>jms.queue.selectorQueue</address>
                <filter string="color='red'"/>
                <durable>true</durable>
            </queue>
            <queue name="jms:queue:Garmin.QueueGarminData24h_Batch_Tuesday">
                <address>jms.queue.selectorQueue</address>
                <filter string="color='red'"/>
                <durable>true</durable>
            </queue>
            <queue name="jms:queue:Garmin.QueueGarminData24h_Batch_Wednesday">
                <address>jms.queue.selectorQueue</address>
                <filter string="color='red'"/>
                <durable>true</durable>
            </queue>
            <queue name="jms:queue:Garmin.QueueGarminData24h_Batch_Thursday">
                <address>jms.queue.selectorQueue</address>
                <filter string="color='red'"/>
                <durable>true</durable>
            </queue>
            <queue name="jms:queue:Garmin.QueueGarminData24h_Batch_Friday">
                <address>jms.queue.selectorQueue</address>
                <filter string="color='red'"/>
                <durable>true</durable>
            </queue>
            <queue name="jms:queue:Garmin.QueueGarminData24h_Batch_Saturday">
                <address>jms.queue.selectorQueue</address>
                <filter string="color='red'"/>
                <durable>true</durable>
            </queue>
        </queue>
        <queue name="jms:queue:Garmin.QueueGarminData24h_Batch_Sunday">
            <address>jms.queue.selectorQueue</address>
            <filter string="color='red'"/>
            <durable>true</durable>
        </queue>
    </queues>

    <security-settings>
        <!--security for queues-->
        <security-setting match="Garmin.#">
           <permission type="createDurableQueue" roles={{ .Values.securityPolicy.createDurableQueueRoles | quote}}/>
           <permission type="deleteDurableQueue" roles={{ .Values.securityPolicy.deleteDurableQueueRoles | quote}}}/>
           <permission type="createNonDurableQueue" roles={{ .Values.securityPolicy.createNonDurableQueueRoles | quote}}/>
           <permission type="deleteNonDurableQueue" roles={{ .Values.securityPolicy.deleteNonDurableQueueRoles | quote}}}/>
           <permission type="send" roles={{ .Values.securityPolicy.sendRoles | quote}}/>
           <permission type="consume" roles={{.Values.securityPolicy.consumeRoles | quote}}/>
        </security-setting>
    </security-settings>

    <address-settings>
    <!--enable instant (no delay) redistribution for all JMS queues and topic subscriptions-->
      <address-setting match="jms.#">
        <redistribution-delay>0</redistribution-delay>
      </address-setting>
    </address-settings>

      </core>
    </configuration>

